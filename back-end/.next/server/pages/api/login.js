"use strict";(()=>{var e={};e.id=994,e.ids=[994],e.modules={9344:e=>{e.exports=require("jsonwebtoken")},1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7618:e=>{e.exports=import("bcryptjs")},6159:(e,o,s)=>{s.a(e,async(e,t)=>{try{s.r(o),s.d(o,{config:()=>i,default:()=>c,routeModule:()=>u});var a=s(1802),r=s(7153),n=s(6249),d=s(6113),l=e([d]);d=(l.then?(await l)():l)[0];let c=(0,n.l)(d,"default"),i=(0,n.l)(d,"config"),u=new a.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/login",pathname:"/api/login",bundlePath:"",filename:""},userland:d});t()}catch(e){t(e)}})},6113:(e,o,s)=>{s.a(e,async(e,t)=>{try{s.r(o),s.d(o,{default:()=>handler});var a=s(5011),r=s(8444),n=s(9344),d=s.n(n),l=e([r]);async function handler(e,o){if(console.log("收到登录请求:",{method:e.method,headers:{"content-type":e.headers["content-type"],"user-agent":e.headers["user-agent"]},body:e.body,query:e.query,cookies:e.cookies,ip:e.socket.remoteAddress}),"POST"!==e.method)return console.log("请求方法不允许:",e.method),o.status(405).json({code:405,message:"方法不允许",data:null});try{await (0,a.Z)();let{username:s,password:t}=e.body;if(console.log("尝试登录用户:",{username:s,passwordProvided:!!t}),!s||!t)return console.log("登录失败: 缺少用户名或密码"),o.status(400).json({code:400,message:"请提供用户名和密码",data:null});let n=await r.Z.findOne({username:s}).select("+password");if(console.log("用户查询结果:",{found:!!n,username:s}),!n)return console.log("登录失败: 用户不存在"),o.status(401).json({code:401,message:"用户名或密码错误",data:null});let l=await n.comparePassword(t);if(console.log("密码验证结果:",{isMatch:l,username:s}),!l)return console.log("登录失败: 密码不匹配"),o.status(401).json({code:401,message:"用户名或密码错误",data:null});let c=process.env.JWT_SECRET||"your-secret-key",i={userId:n._id,username:n.username,role:n.role,email:n.email,status:n.status,exp:Math.floor(Date.now()/1e3)+86400},u=d().sign(i,c);console.log("登录成功, 生成令牌:",{username:s,userId:n._id,role:n.role}),o.status(200).json({code:200,message:"登录成功",data:{token:u,userInfo:i}})}catch(t){console.error("登录过程中发生错误:",t);let s=t instanceof Error?`${t.name}: ${t.message}`:"未知错误";console.error("详细错误信息:",s),console.error("请求信息:",{body:e.body,headers:e.headers,method:e.method}),o.status(500).json({code:500,message:"服务器错误",data:null,debug:void 0})}}r=(l.then?(await l)():l)[0],t()}catch(e){t(e)}})}};var o=require("../../webpack-api-runtime.js");o.C(e);var __webpack_exec__=e=>o(o.s=e),s=o.X(0,[222,227],()=>__webpack_exec__(6159));module.exports=s})();